@page "/board/{id}"
@using Boardify.Components.Modals
@layout FullLayout
@rendermode InteractiveServer
@inject BackendService BackendService

<div class="mb-3 flex items-center justify-between">
    <div class="flex gap-2">
        @if (isBoardNameEdited)
        {
            <InputText @bind-Value="boardNameEdit" type="text" class="input !w-full" placeholder="Name" id="name"
                       required/>
            <button class="btn btn-primary" @onclick="EditBoardName">Ändern</button>
            <button class="btn" @onclick="CancelBoardNameEdit">Abbrechen</button>
        }
        else
        {
            <h2 class="text-3xl font-bold">@board.Name</h2>
            <button class="btn btn-square btn-primary btn-ghost" @onclick="OpenBoardNameEdit">
                <span class="material-icons">edit</span>
            </button>
        }
    </div>
    <a href="/" class="btn btn-square btn-ghost">
        <span class="material-icons">home</span>
    </a>
</div>

<div class="flex flex-col gap-3 md:flex-row">
    @foreach (var (stage, i) in board.Stages.Select((v, i) => (v, i)))
    {
        <div class="flex min-h-96 flex-1 flex-col gap-2 rounded-lg bg-gray-50 p-2"
             @ondrop="() => DropTicket(i)"
             ondragover="event.preventDefault();">
            <div class="mb-2 flex justify-between p-2">
                <h3 class="font-bold text-gray-600 uppercase">@stage.Name</h3>
                <div class="badge badge-soft badge-primary">@GetTicketsInStage(i).Count()</div>
            </div>
            @foreach (var ticket in GetTicketsInStage(i))
            {
                <div class="flex cursor-move flex-col gap-2 rounded-md border-l-4 bg-white p-2 shadow-md 
                            @(ticket.StageNr == 0 ? "border-l-blue-600" : "border-l-blue-400") 
                            @(ticket.IsDone ? "opacity-60" : "")"
                     draggable="true"
                     @ondragstart="() => StartTicketDrag(ticket.Id)"
                     @onclick="() => OpenTicket(ticket.Id)">
                    <div class="text-lg @(ticket.IsDone ? "line-through" : "")">@ticket.Title</div>
                    <div class="flex justify-end text-gray-400">
                        @if (ticket.DueAt == null)
                        {
                            <span>Erstellt am @ticket.CreatedDateFormatted</span>
                        }
                        else
                        {
                            <span>Fällig am @ticket.DueDateFormatted</span>
                        }
                    </div>
                </div>
            }
            <div class="flex justify-center text-gray-400">
                <button class="btn btn-ghost btn-sm flex" @onclick="() => OpenAdd(i)">
                    <span class="material-icons">add</span>
                    Neues Ticket
                </button>
            </div>
        </div>
    }
</div>

<TicketDetailsModal @ref="detailsModal"
                    Board="board"
                    OnEdit="OpenEdit"
                    OnDelete="DeleteOpenedTicket"/>

<TicketAddModal @ref="addModal"
                Board="board"
                OnTicketAdded="HandleTicketAdded"/>

<TicketEditModal @ref="editModal"
                 Board="board"
                 OnTicketUpdated="HandleTicketUpdated"/>

@code {
    [Parameter] public string Id { get; set; } = "";

    private Board board = new()
    {
        Id = "",
        Name = "",
        Stages = new List<Stage>(),
        Tickets = new List<Ticket>(),
        Tags = new List<Tag>()
    };

    private Ticket? draggedTicket;
    private bool isBoardNameEdited;
    private string boardNameEdit = "";

    private TicketDetailsModal detailsModal = null!;
    private TicketAddModal addModal = null!;
    private TicketEditModal editModal = null!;

    protected override async Task OnInitializedAsync()
    {
        board = await BackendService.GetBoard(Id);
    }

    private IEnumerable<Ticket> GetTicketsInStage(int stageNr)
    {
        return board.Tickets.Where(t => t.StageNr == stageNr);
    }

    private async Task DropTicket(int stage)
    {
        if (draggedTicket != null)
        {
            var updatedTicket = await BackendService.UpdateTicket(
                draggedTicket.Id,
                new TicketUpdate { StageNr = stage }
            );

            UpdateTicketInCollection(updatedTicket);
        }
    }

    private void StartTicketDrag(string id)
    {
        draggedTicket = board.Tickets.Find(t => t.Id == id);
    }

    private void OpenTicket(string id)
    {
        var ticket = board.Tickets.Find(t => t.Id == id);
        if (ticket != null)
        {
            detailsModal.Open(ticket);
        }
    }

    private void OpenAdd(int stage)
    {
        addModal.Open(stage);
    }

    private void OpenEdit(Ticket ticket)
    {
        editModal.Open(ticket);
    }

    private async Task DeleteOpenedTicket(Ticket ticket)
    {
        await BackendService.DeleteTicket(ticket.Id);
        board.Tickets.RemoveAll(t => t.Id == ticket.Id);
    }

    private void OpenBoardNameEdit()
    {
        boardNameEdit = board.Name;
        isBoardNameEdited = true;
    }

    private void CancelBoardNameEdit()
    {
        isBoardNameEdited = false;
    }

    private async Task EditBoardName()
    {
        if (string.IsNullOrWhiteSpace(boardNameEdit)) return;

        board.Name = boardNameEdit;
        await BackendService.UpdateBoard(
            board.Id,
            new BoardUpdate { Name = board.Name }
        );

        isBoardNameEdited = false;
    }

    private void HandleTicketAdded(Ticket newTicket)
    {
        board.Tickets.Add(newTicket);
    }

    private void HandleTicketUpdated(Ticket updatedTicket)
    {
        UpdateTicketInCollection(updatedTicket);
    }

    private void UpdateTicketInCollection(Ticket ticket)
    {
        var index = board.Tickets.FindIndex(t => t.Id == ticket.Id);
        if (index != -1)
        {
            board.Tickets[index] = ticket;
        }
        else
        {
            board.Tickets.Add(ticket);
        }
    }

}